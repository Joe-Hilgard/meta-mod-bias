---
title: "Meta-Analysis"
author: "Olivia Cody"
date: "1/30/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(MASS)
library(tidyverse)
library(truncnorm)
library(truncdist)
library(pwr)
library(compiler)
library(metafor)

# load study-simulating functions
source("sim-studies.R")
```


####*Simulate a meta-analytic dataset with dataMA()*
```{r}
dat <- dataMA(k = 50,
              QRP = 0,
              sel =0,
              sigma = 0,
              min = 50, max = 500)

# let's look at it
head(dat)

# let's fit our first meta-analysis
ma1 <- rma(yi = d, sei = se, data = dat)
summary(ma1)
funnel(ma1)
trimfill(ma1)
funnel(trimfill(ma1))

```

####*Simulate a null effect*
```{r}
# simulate null effect dataset with dataMA()
dat.null <- dataMA(k = 50,
              QRP = 0,
              sel =0,
              sigma = 0,
              min = 50, max = 500,
              meanD = 0)

#meta-analysis for a null effect
ma2 = rma(yi = d, sei = se, data = dat.null)
summary(ma2)
funnel(ma2)
forest(ma2)

#same thing but using less data so we can see the forest plot
ma3 = rma(yi = d, sei = se, data = head(dat.null))
summary(ma3)
forest(ma3)
```

####*Techniques for detecting and adjusting bias*
**Ways to detect bias**
- Funnel plots
- Forest plots?
- Egger Test

**Ways to detect and adjust bias**
- Trim and fill
- PET and PEESE
- P-curve
- P-uniform

####*Simulate bias data*
```{r}
dat.bias = dataMA(k = 50,
                  QRP = 0,
                  sel =1, propB = .9,
                  sigma = 0,
                  min = 50, max = 500,
                  meanD = 0)
ma4 = rma(yi = d, sei = se, data = dat.bias)
summary(ma4)
funnel(ma4)
funnel(ma4, refline = 0)
#refline is the vertical reference line values, set to 0 to see bias

#Test for bias: using the egger test
ma4.1 <- rma(yi = d, sei = se,
                  mods = ~se, data = dat.bias)
plot(ma4.1)
funnel(ma4.1)

#:using trim and fill to "correct" data
trimfill(ma4)
funnel(trimfill(ma4), refline = 0)

#:using PET and PEESE
#:using P-curve
#:using P-uniform 
```

####*Simulate a moderator effect (meta-regression)*
```{r}
dat.mod <- data.frame(dat, "mod" = runif(50))
ma5 = rma(yi = d, sei = se, data = dat.mod,
          mods = mod)
summary(ma5)
plot(ma5)

ma6 = rma(yi = d, sei = se, data = dat.bias, mods = se)
plot(ma6)
funnel(ma4)
```

####*Code that does it all in one*
```{r}


```


out <- data.frame(d.obs = summary(ma5)$b[1],
                  se.obs = summary(ma5)$se[1],
                  d.p = summary(ma5)$pval[1],
                  # Moderators
                  # Note that .1 is the intercept, reference group
                  mod.b.obs.1 = summary(ma6)$b[1],
                  mod.b.obs.2 = summary(ma6)$b[2],
                  mod.b.obs.3 = summary(ma6)$b[3],
                  mod.p.1 = summary(ma6)$pval[1],
                  mod.p.2 = summary(ma6)$pval[2],
                  mod.p.3 = summary(ma6)$pval[3],
                  # Egger
                  d.obs.pet = summary(ma7)$b[1],
                  p.pet = summary(ma7)$pval[1],
                  b.egger = summary(ma7)$b[2],
                  p.egger = summary(ma7)$pval[2]
                  # joint PET-RMA tests
)
View(out)
#Explain above?????????????????????????????????????????????????
